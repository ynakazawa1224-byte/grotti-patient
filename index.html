<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>患者入力｜NRS 24h/48h</title>

  <style>
  /* --------- ベース＆スクロール対策 --------- */
  :root { color-scheme: light dark; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji";
    background: #0b1220;      /* ダーク基調（既存トーンに寄せる） */
    color: #e2e8f0;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
  }
  main {
    min-height: 100dvh;       /* モバイルの100vh問題を回避 */
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  header {
    position: sticky; top: 0; z-index: 10;
    background: rgba(11,18,32,.8);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid #23324d;
  }
  .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }

  /* --------- フォーム --------- */
  .card {
    background: #0f172a;
    border: 1px solid #23324d;
    border-radius: 14px;
    padding: 18px;
  }
  label { display:block; margin: 12px 0 6px; color:#cbd5e1; font-weight:600; }
  input, textarea, select, button {
    width: 100%;
    font-size: 16px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #23324d;
    background: #0b1220;
    color: #e2e8f0;
    box-sizing: border-box;
  }
  input::placeholder, textarea::placeholder { color:#93a3b8; }
  textarea { resize: vertical; min-height: 96px; }
  .actions {
    position: sticky; bottom: 0;
    margin-top: 16px;
    padding: 12px 0 0;
    background: linear-gradient(to bottom, rgba(11,18,32,0), rgba(11,18,32,.9) 40%, rgba(11,18,32,1));
  }
  .btn {
    cursor: pointer;
    background: #3b82f6;
    border: 0;
    font-weight: 700;
  }
  .btn:disabled { opacity: .7; cursor: not-allowed; }
  .row { display: grid; gap: 12px; }
  @media (min-width: 560px){
    .row-2 { grid-template-columns: 1fr 1fr; }
    .row-3 { grid-template-columns: 1fr 1fr 1fr; }
  }

  /* --------- 設定パネル（Supabase URL/Key管理） --------- */
  .cfg {
    position: fixed; right: 16px; bottom: 16px; z-index: 20;
    display: grid; gap: 8px; justify-items: end;
  }
  .cfg-panel {
    display:none;
    width: min(92vw, 560px);
    background: #0f172a; border:1px solid #23324d; border-radius: 12px;
    padding: 14px;
  }
  .cfg.open .cfg-panel { display:block; }
  .cfg-btn {
    padding: 10px 12px; border-radius: 12px; background:#1f2937; border:1px solid #23324d;
    color:#e2e8f0; font-weight:700; cursor:pointer;
  }
  .hint { color:#93a3b8; font-size: 12px; margin-top:4px; }
  .ok { color:#22c55e; font-size:12px; }
  .warn { color:#f59e0b; font-size:12px; }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="wrap">
        <h1 style="margin:0; font-size:20px;">患者用入力フォーム（NRS 24h / 48h）</h1>
      </div>
    </header>

    <div class="wrap">
      <div class="card">
        <form id="nrsForm" novalidate>
          <div class="row row-2">
            <div>
              <label for="pid">患者ID（必須）</label>
              <input id="pid" name="pid" type="text" placeholder="例：P001" autocomplete="off" />
            </div>
            <div>
              <label for="date">測定日（未入力なら本日）</label>
              <input id="date" name="date" type="date" />
            </div>
          </div>

          <div class="row row-2">
            <div>
              <label for="nrs24">NRS（24h後）</label>
              <input id="nrs24" name="nrs24" type="number" inputmode="numeric" min="0" max="100" step="1" placeholder="0〜100" />
            </div>
            <div>
              <label for="nrs48">NRS（48h後）</label>
              <input id="nrs48" name="nrs48" type="number" inputmode="numeric" min="0" max="100" step="1" placeholder="0〜100" />
            </div>
          </div>

          <div>
            <label for="memo">メモ（任意）</label>
            <textarea id="memo" name="memo" placeholder="院への伝言、症状メモなど自由記入"></textarea>
          </div>

          <div class="actions">
            <button id="saveBtn" type="submit" class="btn">保存する</button>
          </div>
        </form>
      </div>
      <p class="hint" style="margin-top:10px;">※ 保存後、ブラウザを閉じていただいて問題ありません。</p>
    </div>

    <footer>
      <div class="wrap" style="opacity:.7; font-size:12px; padding-bottom:24px;">
        &copy; GROTTI II PoC
      </div>
    </footer>
  </main>

  <!-- 設定UI（Supabase URL/Keyが未設定のとき使えます） -->
  <div id="cfg" class="cfg">
    <div class="cfg-panel">
      <div style="font-weight:700; margin-bottom:6px;">接続設定（Supabase）</div>
      <label>Project URL
        <input id="cfg-url" placeholder="https://xxxx.supabase.co" />
      </label>
      <label>Anon Key
        <input id="cfg-key" placeholder="長い英数字…" />
      </label>
      <div class="hint">保存するとローカルに記憶され、次回から自動で使われます。</div>
      <div class="row row-2" style="margin-top:10px;">
        <button id="cfg-save" class="btn" type="button">保存</button>
        <button id="cfg-clear" type="button">クリア</button>
      </div>
      <div id="cfg-status" class="hint" style="margin-top:6px;"></div>
    </div>
    <button id="cfg-toggle" class="cfg-btn" type="button">⚙️ 設定</button>
  </div>

  <script type="module">
    // ---- supabase-js を ESM で読み込み
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ---- 設定の取得：window / localStorage / URL(?sburl, ?sbkey) の順で
    function loadConfig() {
      const urlParams = new URLSearchParams(location.search);
      const fromUrl = {
        url: urlParams.get("sburl") || null,
        key: urlParams.get("sbkey") || null,
      };
      const fromWin = {
        url: window.SUPABASE_URL || null,
        key: window.SUPABASE_ANON_KEY || null,
      };
      const fromLS = {
        url: localStorage.getItem("SUPABASE_URL") || null,
        key: localStorage.getItem("SUPABASE_ANON_KEY") || null,
      };
      const cfg = {
        url: fromWin.url || fromUrl.url || fromLS.url,
        key: fromWin.key || fromUrl.key || fromLS.key,
      };
      return cfg;
    }

    function saveConfigToLS(url, key) {
      localStorage.setItem("SUPABASE_URL", url || "");
      localStorage.setItem("SUPABASE_ANON_KEY", key || "");
    }
    function applyCfgUI(cfg) {
      const box = document.getElementById("cfg");
      const urlI = document.getElementById("cfg-url");
      const keyI = document.getElementById("cfg-key");
      const status = document.getElementById("cfg-status");
      urlI.value = cfg.url || "";
      keyI.value = cfg.key || "";
      status.textContent = (cfg.url && cfg.key) ? "✅ 設定済み（このままご利用いただけます）" : "⚠️ 未設定：URL/Keyを入力して保存してください。";
      status.className = (cfg.url && cfg.key) ? "ok" : "warn";
      if (!cfg.url || !cfg.key) box.classList.add("open");
    }

    // ---- Supabaseクライアント初期化（設定が無ければ UI を出す）
    let CFG = loadConfig();
    applyCfgUI(CFG);
    let supabase = null;
    function initClient() {
      if (CFG.url && CFG.key) {
        supabase = createClient(CFG.url, CFG.key);
        return true;
      }
      return false;
    }
    initClient();

    // ---- 設定UIの動作
    const cfgBox = document.getElementById("cfg");
    document.getElementById("cfg-toggle").addEventListener("click", () => {
      cfgBox.classList.toggle("open");
    });
    document.getElementById("cfg-save").addEventListener("click", () => {
      const url = document.getElementById("cfg-url").value.trim();
      const key = document.getElementById("cfg-key").value.trim();
      saveConfigToLS(url, key);
      CFG = loadConfig();
      applyCfgUI(CFG);
      if (initClient()) {
        alert("設定を保存しました。フォームの送信が可能です。");
        cfgBox.classList.remove("open");
      } else {
        alert("URL/Key を確認してください。");
      }
    });
    document.getElementById("cfg-clear").addEventListener("click", () => {
      saveConfigToLS("", "");
      CFG = loadConfig();
      applyCfgUI(CFG);
      supabase = null;
      alert("保存済みの設定を削除しました。");
    });

    // ---- 初期値（URLからの患者ID／本日の日付）
    (function initForm() {
      const pidEl  = document.getElementById("pid");
      const dateEl = document.getElementById("date");
      const params = new URLSearchParams(location.search);
      const qPid = params.get("patient_id") || params.get("pid");
      if (qPid && !pidEl.value) pidEl.value = qPid;
      if (!dateEl.value) {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, "0");
        const dd = String(t.getDate()).padStart(2, "0");
        dateEl.value = `${yyyy}-${mm}-${dd}`;
      }
    })();

    // ---- フォーム送信：patient_nrs へ insert
    document.getElementById("nrsForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!supabase) {
        alert("接続設定が未完了です。右下の「設定」で Supabase URL/Key を保存してください。");
        return;
      }

      const pid  = document.getElementById("pid").value.trim();
      const date = document.getElementById("date").value;     // YYYY-MM-DD
      const n24  = document.getElementById("nrs24").value;
      const n48  = document.getElementById("nrs48").value;
      const memo = document.getElementById("memo").value.trim();

      if (!pid) { alert("患者IDを入力してください。"); return; }

      const createdAt = date
        ? new Date(`${date}T00:00:00`).toISOString()
        : new Date().toISOString();

      const toNumOrNull = (v) => {
        const s = (v ?? "").toString().trim();
        if (s === "") return null;
        const num = Number(s);
        return Number.isFinite(num) ? num : null;
      };

      const payload = {
        patient_id: pid,
        nrs_24h: toNumOrNull(n24),
        nrs_48h: toNumOrNull(n48),
        memo: memo || null,
        created_at: createdAt,   // v_patient_latest で measured_at として使用
      };

      try {
        const { error } = await supabase.from("patient_nrs").insert(payload);
        if (error) throw error;
        alert("保存しました。ご協力ありがとうございます。");
        // 必要ならリセット：e.target.reset();
      } catch (err) {
        console.error(err);
        alert("保存に失敗しました。通信環境や入力内容をご確認のうえ、もう一度お試しください。");
      }
    });
  </script>
</body>
</html>
