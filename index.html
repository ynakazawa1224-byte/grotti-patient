<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>患者用 計測入力（GROTTI II）</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{--bg:#0b1622;--panel:#0f1f2f;--line:#334155;--txt:#e5e7eb;--muted:#9ca3af;--accent:#8b5cf6;--err:#ef4444}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--txt)}
    header{padding:16px;text-align:center;font-size:18px;font-weight:700;border-bottom:1px solid var(--line)}
    main{max-width:720px;margin:0 auto;padding:16px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:0 0 12px}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0c1723}
    .ok{color:#0ea5e9;border-color:#1f2937}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    h2{margin:0 0 8px;font-size:18px}
    label{font-size:14px;color:#cbd5e1;display:block;margin:10px 0 6px}
    input[type="text"],input[type="date"],input[type="number"],textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#09121b;color:var(--txt);font-size:16px;outline:none}
    input[readonly]{opacity:.9;background:#0c1723}
    .hint{font-size:12px;color:#9ca3af;margin-top:6px}
    .btn{width:100%;padding:14px;border-radius:12px;border:1px solid transparent;font-weight:700;font-size:16px;cursor:pointer;background:linear-gradient(90deg,#a78bfa,#60a5fa);color:#0b1020}
    .error{border-color:var(--err)!important}
    .counter{display:flex;justify-content:flex-end;font-size:12px;color:#9ca3af;margin-top:4px}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f1f2f;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:10px 14px;font-size:14px;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none}
    .toast.ok{border-color:#134e4a}.toast.err{border-color:#7f1d1d}
 <style>
/* --- Scroll fix: New Patient フォームを確実にスクロール可能に --- */
html, body { height: 100%; }
body {
  overflow-y: auto !important;           /* 全ページで縦スクロールを許可 */
  overscroll-behavior-y: contain;
  -webkit-overflow-scrolling: touch;     /* iOS の慣性スクロール */
}

/* 100vh問題を回避して、ヘッダーがあっても中身がスクロールできるように */
main, .main, .page, .content {
  min-height: 100dvh;                    /* 動的vhでモバイル対応 */
  overflow-y: auto;                      /* コンテンツ側でも保険で許可 */
}

/* 新規患者ページ（クラス名不明でも効くようにフォームを直接ケア） */
form { 
  max-height: none;                      /* もし固定高があれば無効化 */
}

/* 万が一どこかで overflow: hidden が指定されていた場合の無効化 */
[style*="overflow: hidden"] { overflow: auto !important; }

/* ヘッダーが sticky/fixed の場合に下が隠れないよう保険 */
header { position: sticky; top: 0; z-index: 10; }
body { padding-top: env(safe-area-inset-top); }
</style>

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>患者用 計測入力</header>
  <main>
    <section class="chips">
      <span id="chk-lib" class="chip ok">ライブラリ：OK</span>
      <span id="chk-url" class="chip">Project URL：確認中…</span>
      <span id="chk-key" class="chip">Anon Key：確認中…</span>
    </section>

    <section class="card">
      <h2>入力</h2>

      <label>患者ID（例：P001）</label>
      <input id="patientId" type="text" readonly />
      <div class="hint">URLの <code>?patient_id=XXXX</code> または <code>?pid=XXXX</code> で自動入力されます。</div>

      <label>日付</label>
      <input id="date" type="date" />
      <div class="hint">未選択なら今日の日付を自動セットします。</div>

      <label>24時間後（24h）</label>
      <input id="nrs24" type="number" inputmode="numeric" placeholder="例：70" min="0" max="100" />
      <div class="hint">0〜100 の範囲で入力</div>

      <label>48時間後（48h）</label>
      <input id="nrs48" type="number" inputmode="numeric" placeholder="例：65" min="0" max="100" />
      <div class="hint">0〜100 の範囲で入力</div>

      <label>メモ（任意）</label>
      <textarea id="memo" rows="4" maxlength="200" placeholder="例：右ひざの痛みは夕方に強くなった。鎮痛剤を就寝前に1回服用。"></textarea>
      <div class="counter"><span id="memoCount">0</span>/200</div>

      <div style="margin-top:12px">
        <button id="saveBtn" class="btn">保存する</button>
        <div class="hint" style="margin-top:8px">※ 入力は Supabase に保存され、院内アプリに反映されます。</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">保存しました</div>

  <script>
    // ▼▼▼ ここを実プロジェクトの値に差し替え ▼▼▼
    const SUPABASE_URL = 'https://pseoapqcylxplevuifog.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzZW9hcHFjeWx4cGxldnVpZm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDQ1OTEsImV4cCI6MjA3MzIyMDU5MX0.L0ZmhpzvqNqnrqYHXFuAFc8mgk1I1F-LC1JGhI4pSTE';
    // ▲▲▲ 差し替えはこの2行だけ ▲▲▲

    const { createClient } = window.supabase || {};
    const chipUrl = document.getElementById('chk-url');
    const chipKey = document.getElementById('chk-key');

    let supabase = null;
    const hasKeys =
      /^https:/.test(SUPABASE_URL || '') &&
      (SUPABASE_ANON_KEY || '').length > 40;

    if (hasKeys && createClient) {
      try {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
        chipUrl.textContent = 'Project URL：OK'; chipUrl.classList.add('ok');
        chipKey.textContent = 'Anon Key：OK';   chipKey.classList.add('ok');
      } catch (e) {
        chipUrl.textContent = 'Project URL：ERROR';
        chipKey.textContent = 'Anon Key：ERROR';
        console.error(e);
      }
    } else {
      chipUrl.textContent = 'Project URL：未設定';
      chipKey.textContent = 'Anon Key：未設定';
    }

    const el = {
      pid: document.getElementById('patientId'),
      date: document.getElementById('date'),
      n24: document.getElementById('nrs24'),
      n48: document.getElementById('nrs48'),
      memo: document.getElementById('memo'),
      memoCount: document.getElementById('memoCount'),
      save: document.getElementById('saveBtn'),
      toast: document.getElementById('toast'),
    };

    const pad = n => String(n).padStart(2,'0');
    const todayStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const qp = k => new URLSearchParams(location.search).get(k);
    const in0100 = v => (v === '' || v === null) ? true : (Number(v) >= 0 && Number(v) <= 100 && Number.isFinite(Number(v)));
    const mark = (input, bad) => input.classList.toggle('error', !!bad);
    const toast = (msg, ok=true) => { el.toast.textContent = msg; el.toast.className = 'toast ' + (ok ? 'ok' : 'err'); el.toast.style.display = 'block'; setTimeout(()=> el.toast.style.display='none', 2200); };

    (function init(){
      el.pid.value = qp('patient_id') || qp('pid') || '';
      el.date.value = todayStr();
      const updateCount = () => el.memoCount.textContent = String(el.memo.value.length);
      el.memo.addEventListener('input', updateCount); updateCount();

      const vcheck = () => {
        const a = in0100(el.n24.value), b = in0100(el.n48.value);
        mark(el.n24, !a); mark(el.n48, !b);
        el.save.disabled = !(el.pid.value) || !a || !b;
      };
      ['input','change','blur'].forEach(e=>{
        el.n24.addEventListener(e, vcheck);
        el.n48.addEventListener(e, vcheck);
        el.date.addEventListener(e, vcheck);
      });
      vcheck();
    })();

    el.save.addEventListener('click', async ()=>{
      if(!supabase){ toast('初期化に失敗しました', false); return; }
      const payload = {
        patient_id: (el.pid.value||'').trim(),
        date: el.date.value || todayStr(),
        nrs_24h: el.n24.value === '' ? null : Number(el.n24.value),
        nrs_48h: el.n48.value === '' ? null : Number(el.n48.value),
        memo: (el.memo.value || '').trim() || null,
      };
      if(!payload.patient_id){ toast('患者IDが取得できません', false); return; }
      if(!in0100(el.n24.value) || !in0100(el.n48.value)){ toast('数値は0〜100で入力してください', false); return; }

      el.save.disabled = true;
      try{
        const { error } = await supabase.from('patient_nrs').insert(payload).select();
        if(error) throw error;
        el.n24.value = ''; el.n48.value = ''; mark(el.n24,false); mark(el.n48,false);
        toast('保存しました', true);
      }catch(e){
        console.error(e); toast('保存に失敗しました', false);
      }finally{
        el.save.disabled = false;
      }
    });
  </script>
</body>
</html>
